// Code generated by go run github.com/nfx/slrp/ql/generator/main.go Foo. DO NOT EDIT.
package {{.Type.Package}}

{{if ev }}
import (
	"github.com/nfx/slrp/ql/eval"
)
{{end}}

type {{.Type.Name}}Dataset []{{.Type.Name}}

func (d {{.Type.Name}}Dataset) Query(query string) (*{{ev}}QueryResult[{{.Type.Name}}], error) {
	return (&{{ev}}Dataset[{{.Type.Name}}]{
		Source: d,
		Accessors: {{ev}}Accessors{
			{{range .Type.Fields -}}
				{{FieldTemplate "accessor" .}}
			{{end}}
		},
		Sorters: {{ev}}Sorters[{{.Type.Name}}]{
			{{range .Type.Fields -}}
				"{{.Name}}": {Asc: d.sortAsc{{.Name}}, Desc: d.sortDesc{{.Name}}},
			{{end}}
		},
		Facets: func(t []{{.Type.Name}}, topN int) []eval.Facet {
			r := {{.Type.Name}}Dataset(t)
			return {{ev}}FacetRetrievers[{{.Type.Name}}]{
				{{range .Type.Fields -}}
					{{FieldTemplate "facet" .}}
				{{- end}}
			}.Facets(t, topN)
		},
	}).Query(query)
}

{{range .Type.Fields}}
	{{FieldTemplate "methods" .}}
{{end}}

{{define "facet-string"}}
	{{if .Facet }}
		{{ev}}StringFacet{
			Getter: r.get{{.Name}}, 
			Field: "{{.Name}}", 
			Name: "{{.Facet}}",
		},
	{{end}}
{{end}}
{{define "facet-number"}}{{end}}
{{define "facet-bool"}}{{end}}

{{define "accessor-number"}}
	"{{.Name}}": {{ev}}NumberGetter{Name: "{{.Name}}", Func: d.get{{.Name}}},
{{end}}

{{define "accessor-string"}}
	"{{.Name}}": {{ev}}StringGetter{Name: "{{.Name}}", Func: d.get{{.Name}}},
{{end}}

{{define "accessor-bool"}}
	"{{.Name}}": {{ev}}BooleanGetter{Name: "{{.Name}}", Func: d.get{{.Name}}},
{{end}}

{{define "load"}}
	{{- if eq .Ref.String "time.Time" -}}
	{{.Name}}.Unix()
	{{- else if .Ref.IsStringer -}}
	{{.Name}}.String()
	{{- else -}}
	{{.Name}}
	{{- end -}}
{{end}}

{{define "methods-number"}}
	func (d {{.Of.Name}}Dataset) get{{.Name}}(record int) float64 {
		return float64(d[record].{{template "load" .}})
	}
	{{template "sort" .}}
{{end}}

{{define "methods-string"}}
	func (d {{.Of.Name}}Dataset) get{{.Name}}(record int) string {
		return d[record].{{template "load" .}}
	}
	{{template "sort" .}}
{{end}}

{{define "methods-bool"}}
	func (d {{.Of.Name}}Dataset) get{{.Name}}(record int) bool {
		return d[record].{{.Name}}
	}

	func (_ {{.Of.Name}}Dataset) sortAsc{{.Name}}(left, right {{.Of.Name}}) bool {
		return left.{{.Name}} == right.{{.Name}}
	}

	func (_ {{.Of.Name}}Dataset) sortDesc{{.Name}}(left, right {{.Of.Name}}) bool {
		return left.{{.Name}} != right.{{.Name}}
	}
{{end}}

{{define "sort"}}
	func (_ {{.Of.Name}}Dataset) sortAsc{{.Name}}(left, right {{.Of.Name}}) bool {
		return left.{{template "load" .}} < right.{{template "load" .}}
	}

	func (_ {{.Of.Name}}Dataset) sortDesc{{.Name}}(left, right {{.Of.Name}}) bool {
		return left.{{template "load" .}} > right.{{template "load" .}}
	}
{{end}}